<?xml version="1.0"?>
<ruleset name="NextSkip PMD Ruleset"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0
         https://pmd.sourceforge.io/ruleset_2_0_0.xsd">

    <description>
        PMD ruleset for NextSkip project using PMD 7.x category-based rules.
        Based on PMD best practices, Google Java Style, and Spring Boot conventions.

        Categories included:
        - Best Practices: Generally accepted best practices
        - Code Style: Coding style conventions (selective)
        - Design: Complexity and architectural concerns (selective)
        - Error Prone: Broken or confusing constructs
        - Performance: Suboptimal code patterns
        - Security: Potential security flaws

        References:
        - https://pmd.github.io/pmd/pmd_rules_java.html
        - https://pmd.github.io/pmd/pmd_userdocs_migrating_to_pmd7.html
        - https://github.com/google/physical-web (Google baseline)
        - https://github.com/leanstacks/spring-boot-fundamentals (Spring Boot baseline)
    </description>

    <!-- Best Practices: Core recommended practices -->
    <rule ref="category/java/bestpractices.xml">
        <!-- Allow unit test assertions without messages (they're optional, code is self-documenting) -->
        <exclude name="UnitTestAssertionsShouldIncludeMessage"/>

        <!-- Allow multiple asserts per test (integration tests may verify multiple aspects) -->
        <exclude name="UnitTestContainsTooManyAsserts"/>

        <!-- Allow protected fields in Spring Boot entities (@Column, @ManyToOne, etc.) -->
        <exclude name="AccessorMethodGeneration"/>

        <!-- SLF4J with Logback auto-guards log statements; this rule is outdated for modern logging -->
        <exclude name="GuardLogStatement"/>

        <!-- SAM interfaces without @FunctionalInterface are fine - annotation is documentation only -->
        <exclude name="ImplicitFunctionalInterface"/>
    </rule>

    <!-- Error Prone: Critical bug detection -->
    <rule ref="category/java/errorprone.xml">
        <!-- Exclude from bulk import; we define custom versions below -->
        <exclude name="AvoidFieldNameMatchingMethodName"/>
        <exclude name="TestClassWithoutTestCases"/>
        <!-- Allow null assignments for cleanup (e.g., releasing resources) -->
        <exclude name="NullAssignment"/>

        <!-- Allow immutable DTOs without serialization checks -->
        <exclude name="NonSerializableClass"/>

        <!-- Custom exceptions don't need serialVersionUID - we don't serialize them -->
        <exclude name="MissingSerialVersionUID"/>

        <!-- DTOs and nested static records instantiated by Jackson don't need static factory methods -->
        <exclude name="MissingStaticMethodInNonInstantiatableClass"/>
    </rule>

    <!-- Recognize jqwik @Property methods as valid test methods (not just JUnit @Test) -->
    <rule ref="category/java/errorprone.xml/TestClassWithoutTestCases">
        <properties>
            <property name="violationSuppressXPath"
                      value="//ClassDeclaration[.//MethodDeclaration/ModifierList/Annotation[pmd-java:typeIs('net.jqwik.api.Property')]]"/>
        </properties>
    </rule>

    <!-- Fluent builders intentionally use field names matching setter methods (e.g., name() sets name) -->
    <rule ref="category/java/errorprone.xml/AvoidFieldNameMatchingMethodName">
        <properties>
            <property name="violationSuppressXPath"
                      value="//ClassDeclaration[ends-with(@SimpleName, 'Builder')]"/>
        </properties>
    </rule>

    <!-- Performance: Efficiency patterns -->
    <rule ref="category/java/performance.xml">
        <!-- StringBuilder chaining is clear and idiomatic; no need to force variable reuse -->
        <exclude name="ConsecutiveAppendsShouldReuse"/>

        <!-- StringBuilder initial capacity is premature optimization for short strings -->
        <exclude name="InsufficientStringBufferDeclaration"/>
    </rule>

    <!-- Security: Basic security checks -->
    <rule ref="category/java/security.xml"/>

    <!-- Code Style: Selective naming and formatting rules -->
    <rule ref="category/java/codestyle.xml/MethodNamingConventions">
        <properties>
            <!-- Enforce BDD-style test naming: testMethod_Scenario or testMethod_Scenario_Expected -->
            <!-- Pattern requires at least one underscore after the initial camelCase portion -->
            <property name="junit5TestPattern" value="[a-z][a-zA-Z0-9]+_[a-zA-Z0-9_]+" />
            <!-- Allow jqwik @Property methods to use the same BDD-style naming with underscores -->
            <property name="violationSuppressXPath"
                      value="//MethodDeclaration[ModifierList/Annotation[pmd-java:typeIs('net.jqwik.api.Property')]]"/>
        </properties>
    </rule>
    <rule ref="category/java/codestyle.xml/ClassNamingConventions"/>
    <rule ref="category/java/codestyle.xml/PackageCase"/>
    <rule ref="category/java/codestyle.xml/FieldNamingConventions"/>
    <rule ref="category/java/codestyle.xml/FormalParameterNamingConventions"/>
    <rule ref="category/java/codestyle.xml/LocalVariableNamingConventions"/>

    <!-- Design: Complexity thresholds (Spring Boot adjusted) -->
    <rule ref="category/java/design.xml/CyclomaticComplexity">
        <properties>
            <!-- Allow 25 for complex XML/JSON parsing methods in external API clients -->
            <property name="methodReportLevel" value="25"/>
        </properties>
    </rule>

    <rule ref="category/java/design.xml/TooManyMethods">
        <properties>
            <!-- Default is 10, allowing 20 for Spring Boot controllers/services -->
            <property name="maxmethods" value="20"/>
            <!-- Exclude test classes - comprehensive test suites naturally have many methods -->
            <property name="violationSuppressXPath"
                      value="//ClassDeclaration[matches(@SimpleName, '.*Test$|.*Tests$|.*IT$')]"/>
        </properties>
    </rule>

    <rule ref="category/java/design.xml/ExcessivePublicCount">
        <properties>
            <!-- Default is 45, allowing 60 for Spring Boot configuration classes -->
            <property name="minimum" value="60"/>
        </properties>
    </rule>

    <rule ref="category/java/design.xml/AvoidDeeplyNestedIfStmts">
        <properties>
            <!-- Keep at 3 for readability -->
            <property name="problemDepth" value="3"/>
        </properties>
    </rule>

    <rule ref="category/java/design.xml/NPathComplexity">
        <properties>
            <!-- Default is 200, keeping conservative -->
            <property name="reportLevel" value="200"/>
        </properties>
    </rule>

    <!-- Additional selective design rules -->
    <!-- Note: AvoidCatchingGenericException is in errorprone.xml category (excluded above with @SuppressWarnings) -->
    <rule ref="category/java/design.xml/AvoidThrowingRawExceptionTypes"/>
    <rule ref="category/java/design.xml/SignatureDeclareThrowsException"/>
    <rule ref="category/java/design.xml/SimplifyBooleanReturns"/>
    <rule ref="category/java/design.xml/SimplifyBooleanExpressions"/>

</ruleset>
